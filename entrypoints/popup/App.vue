<template>
  <div class="popup-container">
    <header>
    <img src="/icon/32.png" alt="logo"/>
    <button class="settings-btn" @click="openSettings()" title="설정">
      <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11.893 5.61302C11.9065 5.56224 11.937 5.51823 11.9742 5.48437C12.3094 5.44036 12.6513 5.41667 13 5.41667C13.3487 5.41667 13.6906 5.44036 14.0258 5.48437C14.063 5.51823 14.0901 5.56224 14.107 5.61302L14.5708 7.22786C14.6893 7.6375 14.9838 7.94219 15.3325 8.11146C15.5898 8.23333 15.8336 8.37552 16.0672 8.53463C16.3854 8.75469 16.8018 8.85625 17.2148 8.75469L18.8466 8.34844C18.8974 8.33489 18.9482 8.33828 18.9956 8.35521C19.1784 8.5888 19.3476 8.83594 19.5 9.09323L19.6456 9.34375C19.7878 9.59766 19.913 9.86172 20.0247 10.1326C20.0146 10.1833 19.9909 10.2307 19.9536 10.268L18.7823 11.4766C18.4878 11.7812 18.3693 12.1909 18.3997 12.5768C18.4099 12.7156 18.4167 12.8578 18.4167 13C18.4167 13.1422 18.4099 13.2844 18.3997 13.4232C18.3693 13.8091 18.4878 14.2187 18.7823 14.5234L19.9503 15.732C19.9875 15.7693 20.0112 15.8167 20.0213 15.8674C19.9096 16.1383 19.7844 16.4023 19.6422 16.6596L19.5 16.9068C19.3443 17.1641 19.175 17.4078 18.9956 17.6448C18.9482 17.6617 18.8974 17.6617 18.8466 17.6516L17.2148 17.2453C16.8018 17.1437 16.3888 17.2453 16.0672 17.4654C15.8336 17.6245 15.5898 17.7667 15.3325 17.8885C14.9838 18.0544 14.6859 18.3625 14.5708 18.7721L14.107 20.387C14.0935 20.4378 14.063 20.4818 14.0258 20.5156C13.6906 20.5596 13.3487 20.5833 13 20.5833C12.6513 20.5833 12.3094 20.5596 11.9742 20.5156C11.937 20.4818 11.9099 20.4378 11.893 20.387L11.4292 18.7721C11.3107 18.3625 11.0161 18.0578 10.6674 17.8885C10.4101 17.7667 10.1664 17.6245 9.9328 17.4654C9.61457 17.2453 9.19817 17.1437 8.78515 17.2453L7.15338 17.6516C7.1026 17.6651 7.05182 17.6617 7.00442 17.6448C6.82161 17.4078 6.65234 17.1641 6.49661 16.9068L6.35442 16.6596C6.21223 16.4057 6.08697 16.1417 5.97525 15.8674C5.98541 15.8167 6.00911 15.7693 6.04635 15.732L7.2177 14.5234C7.51223 14.2187 7.63072 13.8091 7.60025 13.4232C7.5901 13.2844 7.58333 13.1422 7.58333 13C7.58333 12.8578 7.5901 12.7156 7.60025 12.5768C7.63072 12.1909 7.51223 11.7812 7.2177 11.4766L6.04973 10.2646C6.01249 10.2273 5.98879 10.1799 5.97864 10.1292C6.09036 9.85833 6.21562 9.59427 6.3578 9.33698L6.49999 9.08984C6.65572 8.83255 6.82499 8.5888 7.0078 8.35182C7.0552 8.33489 7.10598 8.33489 7.15676 8.34505L8.78853 8.7513C9.20155 8.85286 9.61458 8.7513 9.93619 8.53125C10.1698 8.37213 10.4135 8.22995 10.6708 8.10807C11.0195 7.94219 11.3174 7.63411 11.4325 7.22448L11.8963 5.60963L11.893 5.61302ZM13 4.33333C12.5599 4.33333 12.1232 4.36719 11.7 4.43151C11.6424 4.44167 11.5849 4.45859 11.5307 4.48568C11.2091 4.65156 10.9586 4.94609 10.8536 5.3151L10.3898 6.92995C10.3695 7.00443 10.3052 7.08229 10.2003 7.13307C9.89218 7.27864 9.59765 7.4513 9.32004 7.64088C9.22525 7.70521 9.12369 7.72213 9.04921 7.70182L7.41744 7.29557C7.04843 7.20417 6.66926 7.27526 6.36458 7.46823C6.31379 7.4987 6.26978 7.53932 6.23254 7.58672C5.99218 7.88802 5.76874 8.20286 5.569 8.53463L5.56562 8.54479L5.41666 8.80208L5.41327 8.81224C5.23046 9.14401 5.06796 9.48594 4.92916 9.8414C4.90885 9.89557 4.8953 9.95312 4.89192 10.0107C4.87499 10.3763 5.00364 10.7419 5.27109 11.0195L6.43905 12.2281C6.49322 12.2857 6.53046 12.3771 6.5203 12.4922C6.50676 12.6615 6.49999 12.8307 6.49999 13C6.49999 13.1693 6.50676 13.3419 6.5203 13.5078C6.53046 13.6229 6.49322 13.7177 6.43905 13.7719L5.27109 14.9839C5.00364 15.2615 4.87499 15.6271 4.89192 15.9927C4.8953 16.0503 4.90885 16.1078 4.92916 16.162C5.06796 16.5174 5.23046 16.8594 5.41327 17.1911L5.41666 17.2013L5.56562 17.4586L5.569 17.4687C5.76874 17.8005 5.98879 18.1187 6.23254 18.4201C6.26978 18.4674 6.31379 18.5081 6.36458 18.5385C6.66926 18.7315 7.04843 18.8026 7.41744 18.7112L9.04921 18.3049C9.12369 18.2846 9.22525 18.3016 9.32004 18.3659C9.59765 18.5589 9.89218 18.7281 10.2003 18.8737C10.3052 18.9245 10.3661 19.0023 10.3898 19.0768L10.8536 20.6849C10.9586 21.0505 11.2091 21.3451 11.5307 21.5143C11.5849 21.5414 11.6391 21.5617 11.7 21.5685C12.1232 21.6328 12.5599 21.6667 13 21.6667C13.4401 21.6667 13.8768 21.6328 14.3 21.5685C14.3575 21.5583 14.4151 21.5414 14.4693 21.5143C14.7909 21.3484 15.0414 21.0539 15.1463 20.6849L15.6101 19.0701C15.6305 18.9956 15.6948 18.9177 15.7997 18.8669C16.1078 18.7214 16.4023 18.5487 16.6799 18.3591C16.7747 18.2948 16.8763 18.2779 16.9508 18.2982L18.5825 18.7044C18.9516 18.7958 19.3307 18.7281 19.6354 18.5318C19.6862 18.5013 19.7302 18.4607 19.7674 18.4133C20.0078 18.112 20.2279 17.7971 20.4276 17.4654L20.4344 17.4552L20.5833 17.1979L20.5867 17.1878C20.7695 16.8594 20.932 16.5141 21.0708 16.1586C21.0911 16.1044 21.1047 16.0469 21.1081 15.9893C21.125 15.6237 20.9963 15.2581 20.7289 14.9805L19.5609 13.7719C19.5068 13.7143 19.4695 13.6229 19.4797 13.5078C19.4932 13.3385 19.5 13.1693 19.5 13C19.5 12.8307 19.4932 12.6581 19.4797 12.4922C19.4695 12.3771 19.5068 12.2823 19.5609 12.2281L20.7289 11.0195C20.9963 10.7419 21.125 10.3763 21.1081 10.0107C21.1047 9.95312 21.0911 9.89557 21.0708 9.8414C20.932 9.48594 20.7695 9.14401 20.5867 8.81224L20.5833 8.80208L20.4344 8.54479L20.4276 8.53463C20.2279 8.20286 20.0078 7.88463 19.7674 7.58672C19.7302 7.53932 19.6862 7.4987 19.6354 7.46823C19.3307 7.27526 18.9516 7.20417 18.5825 7.29557L16.9508 7.70182C16.8763 7.72213 16.7747 7.70521 16.6799 7.64088C16.4023 7.44792 16.1078 7.27864 15.7997 7.13307C15.6948 7.08229 15.6338 7.00443 15.6101 6.92995L15.1463 5.3151C15.0414 4.94948 14.7909 4.65495 14.4693 4.48568C14.4151 4.45859 14.3609 4.43828 14.3 4.43151C13.8768 4.36719 13.4401 4.33333 13 4.33333ZM11.1042 13C11.1042 12.4972 11.3039 12.015 11.6594 11.6594C12.015 11.3039 12.4972 11.1042 13 11.1042C13.5028 11.1042 13.985 11.3039 14.3405 11.6594C14.6961 12.015 14.8958 12.4972 14.8958 13C14.8958 13.5028 14.6961 13.985 14.3405 14.3406C13.985 14.6961 13.5028 14.8958 13 14.8958C12.4972 14.8958 12.015 14.6961 11.6594 14.3406C11.3039 13.985 11.1042 13.5028 11.1042 13ZM15.9792 13C15.9792 12.2099 15.6653 11.4521 15.1066 10.8934C14.5479 10.3347 13.7901 10.0208 13 10.0208C12.2099 10.0208 11.4521 10.3347 10.8934 10.8934C10.3347 11.4521 10.0208 12.2099 10.0208 13C10.0208 13.7901 10.3347 14.5479 10.8934 15.1066C11.4521 15.6653 12.2099 15.9792 13 15.9792C13.7901 15.9792 14.5479 15.6653 15.1066 15.1066C15.6653 14.5479 15.9792 13.7901 15.9792 13Z" fill="#94A3B8"/>
      </svg>
    </button>
  </header>
  <main>
    <h3>Quick Tools</h3>
    <!-- 로딩 상태 -->
    <div v-if="loading" class="loading">
      로딩 중...
    </div>

    <!-- Empty State (활성화된 플러그인 없음) -->
    <div v-else-if="filteredPlugins.length === 0" class="empty-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M11.6602 1.05956C11.9161 0.967041 12.2008 0.982235 12.4473 1.10546L22.4473 6.10546C22.786 6.27485 23 6.62122 23 6.99999C23 7.37876 22.786 7.72513 22.4473 7.89452L12.4473 12.8945C12.1657 13.0353 11.8343 13.0353 11.5527 12.8945L1.55273 7.89452C1.21395 7.72513 1 7.37876 1 6.99999C1 6.62122 1.21395 6.27485 1.55273 6.10546L11.5527 1.10546L11.6602 1.05956ZM4.23633 6.99999L12 10.8818L19.7637 6.99999L12 3.11816L4.23633 6.99999Z"/>
        <path d="M21.5527 16.1055C22.0467 15.8585 22.6475 16.0587 22.8945 16.5527C23.1415 17.0467 22.9412 17.6475 22.4473 17.8945L12.8945 22.6709C12.3315 22.9524 11.6685 22.9524 11.1055 22.6709L1.55273 17.8945C1.05876 17.6475 0.858479 17.0467 1.10547 16.5527C1.35246 16.0587 1.95329 15.8585 2.44727 16.1055L12 20.8818L21.5527 16.1055Z"/>
        <path d="M21.5527 11.1055C22.0467 10.8585 22.6475 11.0587 22.8945 11.5527C23.1415 12.0467 22.9412 12.6475 22.4473 12.8945L12.8945 17.6709C12.3315 17.9524 11.6685 17.9524 11.1055 17.6709L1.55273 12.8945C1.05876 12.6475 0.858479 12.0467 1.10547 11.5527C1.35246 11.0587 1.95329 10.8585 2.44727 11.1055L12 15.8818L21.5527 11.1055Z"/>
      </svg>
      <h4>No active tools</h4>
      <p>Enable tools in Settings to see them here</p>
      <button @click="openSettings('tools')" class="settings-link">
        Open Settings
      </button>
    </div>

    <!-- 플러그인 리스트 -->
    <div v-else class="plugin-list">
      <PluginCard
          v-for="plugin in filteredPlugins"
          :key="plugin.id"
          :plugin="plugin"
          @execute="executePlugin"
      />
    </div>

  </main>
  </div>
</template>

<script lang="ts" setup>
import { ref, computed, onMounted, onUnmounted } from 'vue';
import type { Plugin, AppState } from '@/types';
import { PluginManager } from '@/core';
import { registerPlugins } from '@/plugins';
import { browser } from 'wxt/browser';
import PluginCard from "@/entrypoints/popup/components/PluginCard.vue";
import {openSettings} from "@/core/OptionsUtils";

const manager = PluginManager.getInstance();
const loading = ref(true);
const enabledPlugins = ref<Plugin[]>([]);

// enabled된 플러그인만 표시
const filteredPlugins = computed(() => {
  return enabledPlugins.value;
});

// enabled된 플러그인만 로드
const loadEnabledPlugins = async () => {
  const allPlugins = manager.getPlugins();
  const enabled: Plugin[] = [];

  for (const plugin of allPlugins) {
    const isEnabled = await manager.isEnabled(plugin.id);
    if (isEnabled) {
      enabled.push(plugin);
    }
  }

  enabledPlugins.value = enabled;
  loading.value = false;
};

// 설정 변경 감지 (플러그인 enable/disable 시)
const handleSettingsChange = async (state: AppState) => {
  await loadEnabledPlugins();
};

// 플러그인 실행
const executePlugin = async (plugin: Plugin) => {
  // Background로 메시지 전송
  await browser.runtime.sendMessage({
    type: plugin.onExecute?.type,
    pluginId : plugin.id,
  });

  window.close();
}

onMounted(async () => {
  // 플러그인 등록 (Popup 컨텍스트에서)
  await registerPlugins();

  // 설정 변경 리스너 등록
  manager.addListener(handleSettingsChange);

  // enabled된 플러그인만 로드
  await loadEnabledPlugins();
});

onUnmounted(() => {
  // 리스너 제거
  manager.removeListener(handleSettingsChange);
});

</script>

<style scoped>

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 10px;
}

.settings-btn {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  background-color: transparent;
  transition: .2s ease;
}
.settings-btn:hover {
  border: 1px solid var(--purple);
  background-color: var(--card-bg-hover);
}
.settings-btn:hover path {
  fill: var(--purple);
}

main {
  padding-top: 10px;
  padding-bottom: 20px;
}

main > h3 {
  padding-left: 8px;
  text-transform: uppercase;
  font-size: 14px;
  color: var(--font-color-2);
  font-weight: 600;
  margin-bottom: 12px;
}
.category-filter button {
  padding: 6px 12px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  white-space: nowrap;
  font-size: 13px;
  transition: all .2s;
}

.category-filter button:hover {
  background: #f9fafb;
}
.category-filter button.active {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.plugin-list {
  height: 312px;
  overflow-y: auto;
  padding: 2px 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.loading {
  padding: 40px 20px;
  text-align: center;
  color: var(--font-color-2);
}

.empty-state {
  padding: 60px 20px;
  text-align: center;
  color: var(--font-color-2);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.empty-state svg {
  opacity: 0.3;
  margin-bottom: 8px;
}

.empty-state h4 {
  font-size: 16px;
  font-weight: 600;
  color: var(--font-color-1);
  margin: 0;
}

.empty-state p {
  font-size: 13px;
  color: var(--font-color-2);
  margin: 0;
}

.settings-link {
  margin-top: 8px;
  padding: 8px 16px;
  background: var(--purple);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.settings-link:hover {
  background: var(--purple);
  transform: translateY(-1px);
}

.disabled {
  h1,h2,h3,h4,h5,h6,span,p,pre,label {
    color: var(--font-disabled);
  }
}
</style>
